---
title: "Neural-net"
author: "Dusty Turner"
format: html
engines:
  R: true
  python: true
cache: true
warning: false
message: false
---

## Testing

```{r}
library(tidyverse)
library(gganimate)
library(arrow)
source(here::here("03-eda","ggtheme_field.R"))

test_joined_with_preds <- read_rds(here::here("04-models", "test_joined_with_preds.rds"))
week_1 <- read_parquet(here::here("02-clean-data", "week_1.parquet"))

```



## Images to Include

```{r}
library(gganimate)

test_joined_with_preds <-
week_1 |> left_join(
test_joined_with_preds |> 
  mutate(game_idplay_id = str_c(game_id, play_id)) |> 
  select(game_idplay_id, display_name, frame_id, final_predictions, binary_predictions)
) 

test_joined_with_preds |> distinct(game_idplay_id, display_name, tackle, position)  |> 
  count(position, tackle) |> 
  filter(tackle == 1) |> 
  mutate(perc_tackle = n / sum(n)) |> select(-tackle, -n) |> 
  left_join(

test_joined_with_preds |> distinct(game_idplay_id, display_name, binary_predictions, position)  |> 
  count(position, binary_predictions) |> 
  filter(binary_predictions == 1) |> 
  mutate(perc_predicted = n / sum(n)) |> select(-binary_predictions, -n))



test_joined_with_preds |> filter(is.na(pass_result)) |> 
  select(display_name, final_predictions, frame_id, tackle, jersey_number, binary_predictions, game_idplay_id, defensive_team) |> 
  filter(binary_predictions == tackle) |>
  filter(tackle == 1) |> 
  filter(defensive_team == "DAL") |> 
  print(n = Inf)



test_joined_with_preds |> filter(is.na(pass_result)) |> count(game_idplay_id) 

stub <- "20220908002072" ## seems too perfect
stub <- "20220908002163" ## good example of a player over performing
stub <- "2022091105889" ## ## good one of a dlineman making a tackle
stub <- "2022091113756" ## ## parsons down field tackle
stub <- "20220911133173" ## donavon wilson

week_1 %>% filter(game_idplay_id == stub) |> filter(tackle == 1) |> select(display_name, jersey_number)

# Assuming week_1 is your data frame
animated_plot <-
  test_joined_with_preds %>% filter(game_idplay_id == stub) |> 
  # left_join(test_joined_with_preds %>% select(game_id, play_id, display_name, frame_id, final_predictions), by = c("game_id", "play_id", "display_name", "frame_id")) %>% 
  filter(!is.na(final_predictions)) %>% 
  group_by(game_id, play_id) %>% 
  # filter(cur_group_id() == 4) |> 
  ungroup()  |> 
  select(frame_id, final_predictions, jersey_number) |> 
  ggplot(aes(x = frame_id, y = final_predictions)) + 
  geom_line() +
  geom_point(show.legend = FALSE, size = 3) + 
  facet_wrap(~jersey_number) +
  transition_reveal(frame_id)

anm1 <- animate(animated_plot, width = 800, height = 600, nframes = 100)

animated_plot2 <-
test_joined_with_preds |> filter(game_idplay_id == stub) |> 
  relocate(final_predictions) |> 
  filter(frame_id <= max(frame_id)-4) |> 
  mutate(final_predictions = ifelse(club == defensive_team & is.na(final_predictions), 0, final_predictions)) |> 
  mutate(color = final_predictions) |> 
  mutate(jersey_number = ifelse(defensive_team == club, jersey_number, "")) |> 
  select(display_name, distance_to_ball, x, y, color, absolute_yardline_number, ball_carrier, play_id, time, play_description, is_football, club, jersey_number, final_predictions, defensive_team, frame_id) %>%
  # select(frame_id, display_name, final_predictions) |> print(n = Inf)
{
  ggplot(data = ., aes(x = x, y = y, color = color)) +
      # ggplot(aes(x = x, y = y, color = color)) +
  geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") +
  geom_point(aes(shape = is_football), size = 3, show.legend = FALSE) +
  geom_text(aes(label = jersey_number), color = "black", nudge_y = -1) +
  scale_color_gradient(low = "grey", high = "black", na.value = "dodgerblue") +
  transition_time(time) + ease_aes("linear") +
  labs(y = "", x = "Yards To Endzone", title = str_wrap(.$play_description[1], width = 80)) +
  theme_field
}



animated_plot2 <-
test_joined_with_preds |> filter(game_idplay_id == stub) |> 
  relocate(final_predictions) |> 
  filter(frame_id <= max(frame_id)-4) |> 
  mutate(final_predictions = ifelse(club == defensive_team & is.na(final_predictions), 0, final_predictions)) |> 
  mutate(color = final_predictions) |> 
  mutate(jersey_number = ifelse(defensive_team == club, jersey_number, "")) |> 
  select(display_name, distance_to_ball, x, y, color, absolute_yardline_number, ball_carrier, play_id, time, play_description, is_football, club, jersey_number, final_predictions, defensive_team, frame_id) %>%
  # select(frame_id, display_name, final_predictions) |> print(n = Inf)
{
  ggplot(data = ., aes(x = x, y = y, color = color)) +
      # ggplot(aes(x = x, y = y, color = color)) +
  geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") +
  geom_point(aes(shape = is_football), size = 3, show.legend = FALSE) +
  geom_text(aes(label = jersey_number), color = "black", nudge_y = -1) +
  scale_color_gradient(low = "grey", high = "black", na.value = "dodgerblue") +
  transition_time(time) + ease_aes("linear") +
  labs(y = "", x = "Yards To Endzone", title = str_wrap(.$play_description[1], width = 80)) +
  theme_field
}

anm2 <- animate(animated_plot2, width = 800, height = 600, nframes = 100)

animated_plot3 <-
test_joined_with_preds |> filter(game_idplay_id == stub) |>   relocate(final_predictions) |> 
  filter(frame_id <= max(frame_id)-4) |> 
  mutate(final_predictions = ifelse(club == defensive_team & is.na(final_predictions), 0, final_predictions)) |> 
  group_by(frame_id) |> 
  mutate(max_predict = final_predictions == max(final_predictions, na.rm = TRUE)) |> 
  ungroup() |> 
  mutate(color = max_predict) |> 
  mutate(jersey_number = ifelse(defensive_team == club, jersey_number, "")) |> 
  select(max_predict, display_name, distance_to_ball, x, y, color, absolute_yardline_number, ball_carrier, play_id, time, play_description, is_football, club, jersey_number, final_predictions, defensive_team, frame_id) %>% 
{
  ggplot(data = ., aes(x = x, y = y, color = color)) +
      # ggplot(aes(x = x, y = y, color = color)) +
  geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") +
  geom_point(aes(shape = is_football), size = 3, show.legend = FALSE) +
  geom_text(aes(label = jersey_number), color = "black", nudge_y = -1) +
  # scale_color_gradient(low = "grey", high = "black", na.value = "dodgerblue") +
  transition_time(time) + ease_aes("linear") +
  labs(y = "", x = "Yards To Endzone", title = str_wrap(.$play_description[1], width = 80)) +
  theme_field
}

anm3 <- animate(animated_plot3, width = 800, height = 600, nframes = 100)

# nn_briar <- 
test_joined_with_preds |> 
  select(game_id, play_id, display_name, frame_id, position) |> 
  left_join(test_joined_with_preds) |> 
  select(game_id, play_id, display_name,tackle, position, final_predictions) |> 
  filter(!is.na(final_predictions)) |> 
  mutate(tackle  = as.integer(as.character(tackle))) |> 
  group_by(game_id, play_id, display_name) |> 
  reframe(expected_prob_of_tackle = mean(final_predictions), tackle = mean(tackle), position = position[1]) |> 
  mutate(tackles_over_expected_play = ifelse(tackle == 1, 1-expected_prob_of_tackle, -expected_prob_of_tackle)) |> 
  group_by(display_name, position) |> 
  reframe(tackles_over_expected = sum(tackles_over_expected_play)) |> 
  arrange(tackles_over_expected) 



```

##

```{r}

players <-
test_joined_with_preds |> filter(game_idplay_id == stub) |> 
  relocate(final_predictions) |> 
  filter(frame_id <= max(frame_id)-4) |> 
  mutate(final_predictions = ifelse(club == defensive_team & is.na(final_predictions), 0, final_predictions)) |> 
  mutate(color = final_predictions) |> 
  mutate(jersey_number = ifelse(defensive_team == club, jersey_number, "")) |> 
  select(display_name, distance_to_ball, x, y, color, absolute_yardline_number, ball_carrier, play_id, time, play_description, is_football, club, jersey_number, final_predictions, defensive_team, frame_id, tackle) 

los_values <- players$x |> range()

players_football <-
  players |> 
    filter(is_football == "football") 

my_custom_blue <- rgb(86, 158, 242, maxColorValue = 255)  

field_anim <-
players |>
  filter(is_football == "not_football") %>%
  mutate(tackle = ifelse(is.na(final_predictions), NA, tackle )) %>%
{
  ggplot(data = ., aes(x = x, y = y, fill = color)) +
  gg_field(yardmin = los_values[1]-3, yardmax = los_values[2]+3) +
  geom_point(shape = 21, size = 5, show.legend = FALSE, aes(color = tackle)) +
  geom_text(aes(label = jersey_number), color = "black", nudge_y = -1) +
  # scale_color_gradient(low = "yellow", high = "red", na.value = "dodgerblue") +
  scale_fill_gradient(low = "orange", high = "red", na.value = my_custom_blue) +
  scale_color_manual(values = c("0" = "black", "1" = "white"), na.value = "black") +
  labs(title = str_wrap(.$play_description[1], width = 80)) +
  geom_point(data = players_football, size = 5, show.legend = FALSE, color = "brown", fill = "brown", shape = 17) +
  transition_time(time) + ease_aes("linear")
}

anm4 <- animate(field_anim, width = 800, height = 600, nframes = 100)

anim_save("animation.gif", animation = anm4)

```




## Distance to the ball

```{r}
week_1 |> 
  filter(game_idplay_id == stub) |> 
  filter(defensive_team == club | is_football == "football") |> 
  mutate(color = ifelse(is_football != "football", distance_to_ball, NA)) |> 
  group_by(frame_id) |> 
    mutate(x_ball = ifelse(display_name == "football", x, NA)) |> 
  mutate(y_ball = ifelse(display_name == "football", y, NA)) |> 
  mutate(x_ball = mean(x_ball, na.rm = TRUE)) |> 
  mutate(y_ball = mean(y_ball, na.rm = TRUE)) |> 
  ungroup() |> 
  select(distance_to_ball, display_name, x, y, x_ball, y_ball, color, absolute_yardline_number, ball_carrier, play_id, time, play_description, is_football, club, distance_to_ball) %>% 
{
  ggplot(data = ., aes(x = x, y = y, color = color)) +
  geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") +
  geom_segment(aes(xend = x_ball, yend = y_ball), color = "black") +
  geom_point(aes(shape = is_football), show.legend = FALSE, size = 5) +
  scale_color_continuous(high = "grey", low = "black") +
  # facet_wrap(~play_id) +
  transition_time(time) + ease_aes("linear") +
  labs(y = "", x = "Yards To Endzone", title = str_wrap(.$play_description[1], width = 80)) +
  theme_field
}

```

## Speed Vector Similarity

```{r}
week_1 |> 
  filter(game_id == dak$game_id[2], play_id %in% unique(dak$play_id)[3]) |> 
  filter(defensive_team == club | is_football == "football") |> 
  mutate(color = ifelse(is_football != "football", distance_to_ball, NA)) |> 
  select(display_name, x, y, x_ball, y_ball, v_approach, color, absolute_yardline_number, ball_carrier, play_id, time, is_football, club, distance_to_ball, play_description) %>% 
{
  ggplot(data = ., aes(x = x, y = y, color = v_approach)) +
  geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") +
  geom_point(aes(shape = is_football), show.legend = FALSE, size = 5) +
  scale_color_gradient2(na.value = "dodgerblue", low = "green", high = "green", mid = "red", midpoint = 0) +
  transition_time(time) + ease_aes("linear") +
  labs(y = "", x = "Yards To Endzone", title = str_wrap(.$play_description[1], width = 80)) +
  theme_field
}
```

## Projected Movement

```{r}

week_1 |> 
  filter(game_id == dak$game_id[2], play_id %in% unique(dak$play_id)[2]) |> 
  filter(defensive_team == club | is_football == "football") |> 
  mutate(color = ifelse(is_football != "football", distance_to_ball, NA)) |> 
  select(display_name, x, y, x_ball, y_ball, v_approach, color, absolute_yardline_number, ball_carrier, play_id, time, is_football, club, distance_to_ball, play_description, x_going, y_going,o, jersey_number) %>% 
{
  ggplot(data = ., aes(x = x, y = y)) +
  geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") +
  geom_point(aes(shape = is_football), show.legend = FALSE, size = 5) +
  # geom_text(aes(label = jersey_number), color = "red", nudge_x = 0, nudge_y = -1) +
  geom_segment(aes(xend = x_going, yend = y_going), arrow = arrow(length = unit(0.03, "npc")), color = "black") +
  # geom_segment(aes(xend = x_going, yend = y_going), arrow = arrow(length = unit(0.02, "npc")), color = "purple") +
  scale_color_gradient2(na.value = "dodgerblue", low = "black", high = "yellow") +
  # facet_wrap(~play_id) +
  transition_time(time) + ease_aes("linear") +
  labs(y = "", x = "Yards To Endzone", title = str_wrap(.$play_description[1], width = 80)) +
  theme_field
}
```

## Orientation Fan

```{r}
week_1 |> 
  filter(game_id == dak$game_id[2], play_id %in% unique(dak$play_id)[2]) |> 
  filter(defensive_team == club | is_football == "football") |> 
  mutate(color = ifelse(ball_in_fan == "yes" | is_football == "football", "No", "Yes")) |> 
  select(frame_id, display_name, x, y, x_facing, y_facing, x_left, x_right, y_left, y_right, v_approach, color, absolute_yardline_number, ball_carrier, play_id, time, is_football, club, distance_to_ball, play_description, x_going, y_going,o, jersey_number) %>%
{
  ggplot(data = ., aes(x = x, y = y, color = color, shape = is_football)) +
  geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") +
  geom_point(show.legend = FALSE, size = 5) +
  geom_segment(aes(xend = x_left, yend = y_left), arrow = arrow(length = unit(0.02, "npc")), color = "purple") +
  geom_segment(aes(xend = x_right, yend = y_right), arrow = arrow(length = unit(0.02, "npc")), color = "purple") +
  transition_states(states = frame_id, transition_length = .1, state_length = .01, wrap = TRUE) +
  labs(y = "", x = "Yards To Line of Scrimage", title = str_wrap(.$play_description[1], width = 80)) +
  theme_field +  guides(shape = "none")
}
```


## Projected Movement with Orientation Fan

```{r}

week_1 |> 
  filter(game_id == dak$game_id[2], play_id %in% unique(dak$play_id)[2]) |> 
  filter(defensive_team == club | is_football == "football") |> 
  mutate(color = ifelse(ball_in_fan == "yes" | is_football == "football", "No", "Yes")) |> 
  select(frame_id, display_name, x, y, x_facing, y_facing, x_left, x_right, y_left, y_right, v_approach, color, absolute_yardline_number, ball_carrier, play_id, time, is_football, club, distance_to_ball, play_description, x_going, y_going,o, jersey_number) %>% 
  {
    ggplot(data = ., aes(x = x, y = y)) +
      geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") +
      geom_point(aes(shape = is_football, color = color), show.legend = FALSE, size = 5) +
      geom_segment(aes(xend = x_left, yend = y_left), arrow = arrow(length = unit(0.02, "npc")), color = "purple") +
      geom_segment(aes(xend = x_right, yend = y_right), arrow = arrow(length = unit(0.02, "npc")), color = "purple") +
      transition_states(states = frame_id, transition_length = .1, state_length = .01, wrap = TRUE) +
      # transition_time(time) + ease_aes("linear") +
      labs(y = "", x = "Yards To Endzone", title = str_wrap(.$play_description[1], width = 80)) +
      theme_field
  }

```

<!-- ## -->

<!-- <iframe width="560" height="315" src="https://www.youtube.com/embed/X3N2tcxgUAM?si=2qHa5V12JeAeXSu_&amp;start=12" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe> -->

## Projected Movement to The Ball

```{r}
week_1 |> 
  filter(game_id == dak$game_id[2], play_id %in% unique(dak$play_id)[2]) |> 
  filter(defensive_team == club | is_football == "football") |> 
  mutate(color = ifelse(is_football != "football", distance_to_ball, NA)) |> 
  select(display_name, x, y, x_ball, y_ball, v_approach, color, absolute_yardline_number, ball_carrier, play_id, time, is_football, club, distance_to_ball, play_description, x_going, y_going, x_ball_next, y_ball_next) %>% 
  # filter(is_football == "football") |> select(x, y, x_going, y_going)
{
  ggplot(data = ., aes(x = x, y = y, color = is_football)) +
  geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") +
  geom_point(aes(shape = is_football), show.legend = FALSE, size = 5) +
  geom_segment(aes(xend = x_ball_next, yend = y_ball_next), color = "black") +
  # scale_color_gradient2(na.value = "dodgerblue", low = "black", high = "yellow") +
  # facet_wrap(~play_id) +
  transition_time(time) + ease_aes("linear") +
  labs(y = "", x = "Yards To Endzone", title = str_wrap(.$play_description[1], width = 80)) +
  theme_field
}
```

<!-- ## Position Identifiers -->

<!-- ```{r} -->
<!-- defensive_model_building_data_model |>  -->
<!--   filter(game_id == dak$game_id[1], play_id %in% unique(dak$play_id)[c(2,3,6,7)]) |>  -->
<!--   filter(frame_id == 1) |>  -->
<!--   filter(defensive_team == club | is_football == "football") |>  -->
<!--   mutate(color = ifelse(is_football != "football", distance_to_ball, NA)) |>  -->
<!--   select(game_id, display_name, x, y, v_approach, color, absolute_yardline_number, ball_carrier, play_id, time, is_football, club, distance_to_ball, play_description, x_going, y_going, alignment) %>%  -->

<!--   { -->
<!--   ggplot(data = ., aes(x = x, y = y, color = alignment)) + -->
<!--   geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") + -->
<!--   geom_point(aes(shape = is_football), show.legend = TRUE, size = 5) + -->
<!--   # transition_time(time) + ease_aes("linear") + -->
<!--   facet_wrap(~play_id, labeller = labeller(play_id = c("89" = "Play 1","110" = "Play 2","179" = "Play 3","200" = "Play 4"))) + -->
<!--   labs(y = "", x = "Yards To Endzone", title = "") + -->
<!--   theme_field + -->
<!--       guides(shape = "none") + -->
<!--   theme(legend.position = "bottom")  -->

<!-- } -->

<!-- ``` -->

## Positions

```{r}

defensive_model_building_data |>
  filter(game_id == dak$game_id[1], play_id %in% unique(dak$play_id)[c(2,3,7,8)]) |>
  filter(frame_id == 1) |>
  filter(defensive_team == club | is_football == "football") |>
  mutate(color = ifelse(is_football != "football", distance_to_ball, NA)) |>
  select(game_id, display_name, x, y, v_approach, color, absolute_yardline_number, ball_carrier, play_id, time, is_football, club, distance_to_ball, play_description, x_going, y_going, position) %>%

  {
  ggplot(data = ., aes(x = x, y = y, color = position)) +
  geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") +
  geom_point(aes(shape = is_football), show.legend = TRUE, size = 4) +
  # transition_time(time) + ease_aes("linear") +
  facet_wrap(~play_id, labeller = labeller(play_id = c("89" = "Play 1","110" = "Play 2","200" = "Play 3","246" = "Play 4"))
             ) +
  labs(y = "", x = "Yards To Endzone", title = "") +
  theme_field +
      guides(shape = "none") +
  theme(legend.position = "bottom")

}
```

## Start Points

```{r}
week_1 |> 
  filter(str_detect(event, "snap")) |> 
  filter(club != possession_team) |> 
  select(position, x, y, yardline_number, absolute_yardline_number, event) |> 
  mutate(x_from_los = abs(absolute_yardline_number - x)) |> 
  ggplot(aes(x = x_from_los, y = y)) +
  ggdensity::geom_hdr() +
  theme_field +
  theme(legend.position = "none") +
  labs(x = "Distance from Line of Scrimage", y = "")
```

## Alignment Clusters

```{r}
defensive_model_building_data |> 
  # filter(game_id == dak$game_id[1], play_id %in% unique(dak$play_id)[c(2,3,6,7)]) |> 
  filter(frame_id == 6) |> 
  filter(defensive_team == club | is_football == "football") |> 
  filter(is.na(pass_result))  |> 
  # mutate(color = as.factor(alignment_cluster)) |>
  select(game_id, display_name, x, x_from_los, y, v_approach, absolute_yardline_number, ball_carrier, play_id, time, is_football, club, distance_to_ball, play_description, x_going, y_going, alignment, alignment_cluster) %>%
  
  {
  ggplot(data = ., aes(x = x_from_los, y = y, color = alignment_cluster)) +
  # geom_vline(aes(xintercept = absolute_yardline_number), color = "blue") +
  geom_point(aes(shape = is_football), show.legend = TRUE, size = 1) +
  # transition_time(time) + ease_aes("linear") +
  # facet_wrap(~play_id, labeller = labeller(play_id = c("89" = "Play 1","110" = "Play 2","179" = "Play 3","200" = "Play 4"))) +
  labs(y = "", x = "Yards To Line of Scrimage", title = "", color = "Alignment Cluster") +
  theme_field +
      guides(shape = "none") +
  theme(legend.position = "bottom") 
  
}

```



